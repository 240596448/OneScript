<Project Sdk="Microsoft.NET.Sdk">
	<Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets" />
	
	<PropertyGroup>
		<ReleaseNumber Condition="'$(ReleaseNumber)' == ''">19</ReleaseNumber>
		<ArtifactsRoot>$(MSBuildProjectDirectory)/built</ArtifactsRoot>
		<Solution>$(MSBuildProjectDirectory)/src/1Script.sln</Solution>
		<Configuration>Release</Configuration>
		<TargetFrameworks>net452;netstandard2.0</TargetFrameworks>

	</PropertyGroup>
	
	<Target Name="Clean">
	
		<ItemGroup>
			<TestsResults Include="$(MSBuildProjectDirectory)/tests/*.os.xml" />
		</ItemGroup>
	
		<Delete Files="@(TestsResults)" />
		<DeleteTree Directories="$(ArtifactsRoot)/**/*" Condition="Exists($(ArtifactsRoot))" />
		
		<MSBuild Projects="$(Solution)" Targets="Clean" Properties="Configuration=$(Configuration)" />
		
	</Target>
	
	<Target Name="Compile">
		
		<ItemGroup>
			<ProjectsToBuild Include="$(Solution)">
				<Properties>Configuration=Release;Platform=x86</Properties>
			</ProjectsToBuild>
		</ItemGroup>
		
		<MSBuild Projects="@(ProjectsToBuild)" Targets="Build" />
			
	</Target>
	
	<Target Name="PrepareArtifactsRoot">
		<MakeDir Directories="$(ArtifactsRoot)" />
		<MakeDir Directories="$(ArtifactsRoot)/tmp" />
	</Target>
	
	<Target Name="PrepareDistributionContent" DependsOnTargets="Compile;PrepareArtifactsRoot">
		<PropertyGroup>
			<TempFolder>$(ArtifactsRoot)/tmp</TempFolder>
			<BinFolder>$(TempFolder)/bin</BinFolder>
			<LibFolder>$(TempFolder)/lib</LibFolder>
			<ExamplesFolder>$(TempFolder)/examples</ExamplesFolder>
		</PropertyGroup>
		<MakeDir Directories="$(BinFolder)" />
		
		<ItemGroup>
			<BuiltProjects Include="oscript" />
			<BuiltProjects Include="TestApp" />
			<ExcludedArtifacts Include="$(BinFolder)/*.pdb" />
			<ExcludedArtifacts Include="$(BinFolder)/*.xml" />
			
			<BinaryFiles Include="$(MSBuildProjectDirectory)/src/%(BuiltProjects.Identity)/bin/x86/$(Configuration)/net452/**"/>
			<LibraryFiles Include="$(MSBuildProjectDirectory)\oscript-library\src\**\*" Exclude="$(MSBuildProjectDirectory)\oscript-library\**\*.git"/>
			<ExampleFiles Include="$(MSBuildProjectDirectory)\install\examples\**\*"/>
			
		</ItemGroup>
		
		<Copy SourceFiles="@(BinaryFiles)" DestinationFolder="$(BinFolder)" />
		<Copy SourceFiles="@(LibraryFiles)" DestinationFolder="$(LibFolder)\%(RecursiveDir)"/> 
		<Copy SourceFiles="@(ExampleFiles)" DestinationFolder="$(ExamplesFolder)\%(RecursiveDir)"/> 
		<Delete Files="@(ExcludedArtifacts)"/>
		
	</Target>
	
</Project>