<Project Sdk="Microsoft.NET.Sdk">
	<Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets" />
	
	<PropertyGroup>
		<ReleaseNumber Condition="'$(ReleaseNumber)' == ''">19</ReleaseNumber>
		<ArtifactsRoot>$(MSBuildProjectDirectory)/built</ArtifactsRoot>
		<Solution>$(MSBuildProjectDirectory)/src/1Script.sln</Solution>
		<Configuration>Release</Configuration>
		<TargetFrameworks>net452;netstandard2.0</TargetFrameworks>

	</PropertyGroup>
	
	<Target Name="Clean">
	
		<ItemGroup>
			<TestsResults Include="$(MSBuildProjectDirectory)/tests/*.os.xml" />
		</ItemGroup>
	
		<Delete Files="@(TestsResults)" />
		<DeleteTree Directories="$(ArtifactsRoot)/**/*" Condition="Exists($(ArtifactsRoot))" />
		
		<MSBuild Projects="$(Solution)" Targets="Clean" Properties="Configuration=$(Configuration)" />
		
	</Target>
	
	<Target Name="Compile">
		
		<ItemGroup>
			<ProjectsToBuild Include="$(Solution)">
				<Properties>Configuration=Release;Platform=x86</Properties>
			</ProjectsToBuild>
		</ItemGroup>
		
		<MSBuild Projects="@(ProjectsToBuild)" Targets="Build" />
			
	</Target>
	
	<Target Name="PrepareArtifactsRoot">
		<MakeDir Directories="$(ArtifactsRoot)" />
		<MakeDir Directories="$(ArtifactsRoot)/tmp" />
	</Target>
	
	<Target Name="CopyBinFiles" DependsOnTargets="Compile;PrepareArtifactsRoot">
		<PropertyGroup>
			<TempFolder>$(ArtifactsRoot)/tmp</TempFolder>
			<BinFolder>$(TempFolder)/bin</BinFolder>
		</PropertyGroup>
		<MakeDir Directories="$(BinFolder)" />
		
		<ItemGroup>
			<BuiltProjects Include="oscript" />
			<BuiltProjects Include="TestApp" />
			<ExcludedArtifacts Include="*.pdb" />
			<ExcludedArtifacts Include="*.xml" />
			<SourceFiles Include="$(MSBuildProjectDirectory)/src/%(BuiltProjects.Identity)/bin/x86/$(Configuration)/net452/**"
                   Exclude="*.pdb"/>
		</ItemGroup>
		
		<Copy SourceFiles="@(SourceFiles)" DestinationFolder="$(BinFolder)" />
		
	</Target>
	
</Project>